<div class="project-board">
  <app-flash-messages></app-flash-messages>

  <div class="page-overlay" *ngIf="pageLoading">
    <div class="spinner-container">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  </div>

  <div class="project-header">
    <div class="project-image-container">
      <div class="project-image">
        <img *ngIf="projectImage" [src]="projectImage" alt="Project Image" />
        <div
          *ngIf="!projectImage"
          class="placeholder"
          [innerHTML]="placeholderSvg"
        ></div>
        <!-- Added this button -->
        <button
          *ngIf="canManageProject"
          class="edit-image-button"
          (click)="openEditProjectImageModal()"
          title="Edit project image"
        >
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>

    <div class="project-info">
      <div class="project-title-section">
        <h1>{{ projectName }}</h1>
        <div class="project-actions" *ngIf="canManageStagesAndTasks()">
          <button class="btn-primary" (click)="openCreateStageModal()">
            <i class="fas fa-columns"></i> New Stage
          </button>
        </div>
      </div>

      <p class="project-description">{{ projectDescription }}</p>

      <div class="project-meta">
        <div class="meta-item">
          <i class="fas fa-clock"></i>
          <span
            class="project-status"
            [ngClass]="getStatusClass(projectStatus)"
            >{{ projectStatus }}</span
          >
        </div>
        <div class="meta-item">
          <i class="fas fa-flag"></i>
          <span
            class="project-priority"
            [ngClass]="getProjectPriorityClass(projectPriority)"
            >{{ projectPriority }}</span
          >
        </div>
        <div class="meta-item">
          <i class="fas fa-calendar"></i>
          <span class="project-due-date"
            >Due: {{ formatDate(projectDueDate) }}</span
          >
        </div>
      </div>

      <div class="project-people">
        <div class="people-item" *ngIf="projectManager">
          <div class="people-label">
            <i class="fas fa-user-tie"></i>
            <span>Manager</span>
          </div>
          <div class="people-info">
            <div class="avatar">{{ projectManager.fullName.charAt(0) }}</div>
            <span>{{ projectManager.fullName }}</span>
          </div>
        </div>
        <div class="people-item" *ngIf="projectCreatedBy">
          <div class="people-label">
            <i class="fas fa-user-edit"></i>
            <span>Created by</span>
          </div>
          <div class="people-info">
            <div class="avatar">{{ projectCreatedBy.fullName.charAt(0) }}</div>
            <span>{{ projectCreatedBy.fullName }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="project-tabs">
    <button
      [ngClass]="{ active: activeTab === 'board' }"
      (click)="setActiveTab('board')"
    >
      Board
    </button>
    <button
      [ngClass]="{ active: activeTab === 'employees' }"
      (click)="setActiveTab('employees')"
    >
      Employees
    </button>
    <button
      [ngClass]="{ active: activeTab === 'documents' }"
      (click)="setActiveTab('documents')"
    >
      Documents
    </button>
  </div>

  <div [ngSwitch]="activeTab">
    <div *ngSwitchCase="'board'">
      <div class="search-section">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            placeholder="Filter tasks by title or description"
            [(ngModel)]="searchQuery"
          />
        </div>
        <div class="filter-actions">
          <button class="btn-secondary">
            <i class="fas fa-sort"></i> Sort
          </button>
          <button class="btn-secondary">
            <i class="fas fa-filter"></i> Filter
          </button>
        </div>
      </div>

      <div *ngIf="error" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        {{ error }}
      </div>

      <div
        *ngIf="!loading && !error && columns.length === 0"
        class="no-results"
      >
        <i class="fas fa-columns"></i>
        <p>
          No stages found for this project. Create a new stage to get started.
        </p>
        <button
          *ngIf="canManageStagesAndTasks()"
          class="btn-primary"
          (click)="openCreateStageModal()"
        >
          <i class="fas fa-plus"></i> Create First Stage
        </button>
      </div>

      <div class="board-content">
        <div class="column" *ngFor="let column of columns">
          <div class="column-header">
            <div class="column-title">
              <span
                class="status-dot"
                [style.backgroundColor]="column.color"
              ></span>
              {{ column.name }}
              <span class="count">{{ column.total }}</span>
            </div>
            <div class="column-actions" *ngIf="canManageStagesAndTasks()">
              <button
                class="btn-icon"
                (click)="openEditStageModal(column.id)"
                title="Edit Stage"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-icon"
                (click)="openDeleteStageModal(column.id)"
                title="Delete Stage"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>

          <div class="column-description">
            {{ column.description }}
          </div>

          <div
            class="task-list"
            cdkDropList
            [id]="column.id"
            [cdkDropListData]="column.tasks"
            (cdkDropListDropped)="drop($event)"
            [cdkDropListConnectedTo]="columnIds"
          >
            <div
              class="task-card"
              *ngFor="let task of column.tasks | filter: searchQuery"
              cdkDrag
              tabindex="0"
              (click)="openEditTaskModal(task)"
              (keydown.enter)="openEditTaskModal(task)"
            >
              <div class="task-header">
                <span class="task-id">#{{ task.id.toString().slice(-4) }}</span>
                <div class="task-actions">
                  <button
                    class="btn-icon-sm"
                    (click)="openViewTaskModal(task); $event.stopPropagation()"
                    (keydown.enter)="
                      openViewTaskModal(task); $event.stopPropagation()
                    "
                    title="View Task"
                    tabindex="0"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="btn-icon-sm"
                    *ngIf="canManageStagesAndTasks()"
                    (click)="openEditTaskModal(task); $event.stopPropagation()"
                    (keydown.enter)="
                      openEditTaskModal(task); $event.stopPropagation()
                    "
                    title="Edit Task"
                    tabindex="0"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn-icon-sm"
                    *ngIf="canManageStagesAndTasks()"
                    (click)="
                      openDeleteTaskModal(task); $event.stopPropagation()
                    "
                    (keydown.enter)="
                      openDeleteTaskModal(task); $event.stopPropagation()
                    "
                    title="Delete Task"
                    tabindex="0"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
              <div class="task-title">{{ task.title }}</div>
              <div class="task-description" *ngIf="task.description">
                {{ task.description | slice: 0 : 50
                }}{{ task.description.length > 50 ? '...' : '' }}
              </div>
              <div class="task-footer">
                <div class="task-meta">
                  <span class="task-assignee">
                    <i class="fas fa-user"></i>
                    {{ getAssignedUserName(task.assignedTo) }}
                  </span>
                  <span
                    class="task-priority"
                    [ngClass]="getPriorityClass(task.priority)"
                  >
                    {{ formatPriority(task.priority) }}
                  </span>
                </div>
              </div>
            </div>

            <div class="add-item-container" *ngIf="canManageStagesAndTasks()">
              <button
                class="add-item-button"
                (click)="openCreateTaskModal(column.id)"
                (keydown.enter)="openCreateTaskModal(column.id)"
                tabindex="0"
              >
                <i class="fas fa-plus"></i> Add task
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngSwitchCase="'employees'" class="documents-tab">
      <div class="section-header">
        <h2>Project Team</h2>
        <!-- <button class="btn-primary add-document-btn" *ngIf="canManageProject">
          <i class="fas fa-plus"></i> Add Team Member
        </button> -->
      </div>

      <div class="search-section">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            placeholder="Search employees by name"
            [(ngModel)]="employeeSearchQuery"
            (ngModelChange)="searchEmployees()"
          />
        </div>
        <div class="filter-actions">
          <button class="btn-secondary">
            <i class="fas fa-sort"></i> Sort
          </button>
          <button class="btn-secondary">
            <i class="fas fa-filter"></i> Filter
          </button>
        </div>
      </div>

      <div class="documents-table-container">
        <table class="documents-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Email</th>
              <th>Role</th>
              <th>Join Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let employee of paginatedEmployees">
              <td class="document-name-cell">
                <div class="document-icon avatar">
                  {{ employee.fullName.charAt(0) }}
                </div>
                <div class="document-info">
                  <span class="document-title">{{ employee.fullName }}</span>
                  <span class="document-url">Team Member</span>
                </div>
              </td>
              <td>contactworknest.fr</td>
              <td>
                <span
                  class="document-type"
                  [ngClass]="getRoleClass(employee.role)"
                >
                  {{ formatRole(employee.role) }}
                </span>
              </td>
              <td>Mar 11, 2025</td>
              <td>
                <span class="status-badge status-active">Active</span>
              </td>
              <!-- Remplacez la section des actions de document dans votre tableau par ceci -->
              <td>
                <div class="document-actions">
                  <button class="btn-icon" title="View Document">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-icon" title="Download">
                    <i class="fas fa-download"></i>
                  </button>
                  <button
                    class="btn-icon"
                    title="Edit"
                    *ngIf="canManageProject"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn-icon delete"
                    title="Delete"
                    *ngIf="canManageProject"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!paginatedEmployees?.length" class="no-documents">
        <div class="empty-state">
          <i class="fas fa-users"></i>
          <h3>No team members yet</h3>
          <!-- <p>Add team members to collaborate on this project</p> -->
          <!-- <button class="btn-primary" *ngIf="canManageProject" disabled>
            <i class="fas fa-plus"></i> Add First Team Member
          </button> -->
        </div>
      </div>

      <div class="pagination">
        <button
          class="pagination-button"
          (click)="previousPage()"
          [disabled]="currentPage === 1"
        >
          <i class="fas fa-chevron-left"></i>
          Previous
        </button>

        <div class="page-numbers">
          <ng-container *ngFor="let page of getPageNumbers()">
            <ng-container *ngIf="page === '...'">
              <div class="ellipsis">...</div>
            </ng-container>
            <ng-container *ngIf="page !== '...'">
              <button
                class="page-number"
                [class.active]="page === currentPage"
                (click)="goToPage(page)"
              >
                {{ page }}
              </button>
            </ng-container>
          </ng-container>
        </div>

        <button
          class="pagination-button"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
        >
          Next
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <div *ngSwitchCase="'documents'" class="documents-tab">
      <div class="section-header">
        <h2>Project Documents</h2>
        <button
          class="btn-primary add-document-btn"
          *ngIf="canManageProject"
          (click)="openAddDocumentModal()"
        >
          <i class="fas fa-plus"></i> Add New Document
        </button>
      </div>

      <div class="search-section">
        <div class="search-container">
          <input
            type="text"
            class="search-input"
            placeholder="Search documents..."
            [(ngModel)]="documentSearchQuery"
            (ngModelChange)="searchDocuments()"
          />
        </div>
        <div class="filter-actions">
          <button class="btn-secondary">
            <i class="fas fa-sort"></i> Sort
          </button>
          <button class="btn-secondary">
            <i class="fas fa-filter"></i> Filter
          </button>
        </div>
      </div>

      <div class="documents-table-container">
        <table class="documents-table">
          <thead>
            <tr>
              <th>Document Name</th>
              <th>Type</th>
              <th>Added Date</th>
              <th>Size</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let document of paginatedDocuments">
              <td class="document-name-cell">
                <div class="document-icon">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <div class="document-info">
                  <span class="document-title">{{
                    getDocumentName(document)
                  }}</span>
                  <span class="document-url">{{ document }}</span>
                </div>
              </td>
              <td>
                <span class="document-type">PDF</span>
              </td>
              <td>Mar 11, 2025</td>
              <td>2.4 MB</td>
              <td>
                <span class="status-badge status-active">Active</span>
              </td>
              <td>
                <div class="document-actions">
                  <button
                    class="btn-icon"
                    title="View Document"
                    (click)="viewDocument(document)"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="btn-icon"
                    title="Download"
                    (click)="downloadDocument(document)"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <button
                    class="btn-icon delete"
                    title="Delete"
                    *ngIf="canManageProject"
                    (click)="openDeleteDocumentModal(document)"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!filteredDocuments?.length" class="no-documents">
        <div class="empty-state">
          <i class="fas fa-file-alt"></i>
          <h3>No documents yet</h3>
          <p *ngIf="canManageStagesAndTasks()">Add documents to share with your team</p>
          <button class="btn-primary" *ngIf="canManageStagesAndTasks()" (click)="openAddDocumentModal()">
            <i class="fas fa-plus"></i> Add First Document
          </button>
        </div>
      </div>

      <div class="pagination">
        <button
          class="pagination-button"
          (click)="previousDocumentPage()"
          [disabled]="documentCurrentPage === 1"
        >
          <i class="fas fa-chevron-left"></i>
          Previous
        </button>

        <div class="page-numbers">
          <ng-container *ngFor="let page of getDocumentPageNumbers()">
            <ng-container *ngIf="page === '...'">
              <div class="ellipsis">...</div>
            </ng-container>
            <ng-container *ngIf="page !== '...'">
              <button
                class="page-number"
                [class.active]="page === documentCurrentPage"
                (click)="goToDocumentPage(page)"
              >
                {{ page }}
              </button>
            </ng-container>
          </ng-container>
        </div>

        <button
          class="pagination-button"
          (click)="nextDocumentPage()"
          [disabled]="documentCurrentPage === documentTotalPages"
        >
          Next
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="showAddDocumentModal">
    <div
      class="modal-overlay"
      (click)="closeAddDocumentModal()"
      (keydown.escape)="closeAddDocumentModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Document</h2>
        <button class="close-button" (click)="closeAddDocumentModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form
          [formGroup]="addDocumentForm"
          (ngSubmit)="submitAddDocumentForm()"
        >
          <div class="form-group">
            <label for="file">
              Document File <span class="required">*</span>
            </label>
            <div
              class="file-upload"
              (click)="fileInput.click()"
              (keydown.enter)="fileInput.click()"
              tabindex="0"
              role="button"
              aria-label="Upload document"
            >
              <input
                #fileInput
                type="file"
                id="file"
                accept=".pdf,.doc,.docx"
                (change)="onFileSelected($event)"
                style="display: none"
              />
              <i class="fas fa-cloud-upload-alt"></i>
              <p class="upload-text">
                {{
                  selectedFile ? selectedFile.name : 'Click to upload document'
                }}
              </p>
            </div>
            <div
              class="error-message"
              *ngIf="
                addDocumentForm.get('file')?.invalid &&
                addDocumentForm.get('file')?.touched
              "
            >
              Please select a document to upload
            </div>
          </div>

          <div class="form-error" *ngIf="formError">
            <i class="fas fa-exclamation-triangle"></i>
            {{ formError }}
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="cancel-button"
              (click)="closeAddDocumentModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="formSubmitting || addDocumentForm.invalid"
            >
              <i class="fas fa-save"></i>
              <span *ngIf="formSubmitting">Uploading...</span>
              <span *ngIf="!formSubmitting">Upload Document</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Stage Modal -->
  <div class="modal" *ngIf="showCreateStageModal">
    <div
      class="modal-overlay"
      (click)="closeCreateStageModal()"
      (keydown.escape)="closeCreateStageModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Stage</h2>
        <button class="close-button" (click)="closeCreateStageModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form
          [formGroup]="createStageForm"
          (ngSubmit)="submitCreateStageForm()"
        >
          <div class="form-group">
            <label for="name">Stage Name <span class="required">*</span></label>
            <input
              type="text"
              id="name"
              formControlName="name"
              [class.invalid]="isInvalidControl(createStageForm, 'name')"
              placeholder="Enter stage name"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(createStageForm, 'name')"
            >
              {{ getControlErrorMessage(createStageForm, 'name') }}
            </div>
          </div>

          <div class="form-group">
            <label for="color">Color <span class="required">*</span></label>
            <input
              type="color"
              id="color"
              formControlName="color"
              [class.invalid]="isInvalidControl(createStageForm, 'color')"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(createStageForm, 'color')"
            >
              {{ getControlErrorMessage(createStageForm, 'color') }}
            </div>
          </div>

          <input type="hidden" formControlName="position" />

          <div class="form-error" *ngIf="formError">
            <i class="fas fa-exclamation-triangle"></i>
            {{ formError }}
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="cancel-button"
              (click)="closeCreateStageModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="formSubmitting || createStageForm.invalid"
            >
              <i class="fas fa-save"></i>
              <span *ngIf="formSubmitting">Creating...</span>
              <span *ngIf="!formSubmitting">Create Stage</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Stage Modal -->
  <div class="modal" *ngIf="showEditStageModal">
    <div
      class="modal-overlay"
      (click)="closeEditStageModal()"
      (keydown.escape)="closeEditStageModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Stage</h2>
        <button class="close-button" (click)="closeEditStageModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editStageForm" (ngSubmit)="submitEditStageForm()">
          <div class="form-group">
            <label for="edit-name"
              >Stage Name <span class="required">*</span></label
            >
            <input
              type="text"
              id="edit-name"
              formControlName="name"
              [class.invalid]="isInvalidControl(editStageForm, 'name')"
              placeholder="Enter stage name"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(editStageForm, 'name')"
            >
              {{ getControlErrorMessage(editStageForm, 'name') }}
            </div>
          </div>

          <div class="form-group">
            <label for="edit-color"
              >Color <span class="required">*</span></label
            >
            <input
              type="color"
              id="edit-color"
              formControlName="color"
              [class.invalid]="isInvalidControl(editStageForm, 'color')"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(editStageForm, 'color')"
            >
              {{ getControlErrorMessage(editStageForm, 'color') }}
            </div>
          </div>

          <div class="form-group">
            <label for="edit-position">Position</label>
            <input
              type="number"
              id="edit-position"
              formControlName="position"
              min="0"
            />
            <small>Lower numbers appear first</small>
          </div>

          <div class="form-error" *ngIf="formError">
            <i class="fas fa-exclamation-triangle"></i>
            {{ formError }}
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="cancel-button"
              (click)="closeEditStageModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="formSubmitting || editStageForm.invalid"
            >
              <i class="fas fa-save"></i>
              <span *ngIf="formSubmitting">Updating...</span>
              <span *ngIf="!formSubmitting">Update Stage</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Stage Modal -->
  <div class="modal" *ngIf="showDeleteStageModal">
    <div
      class="modal-overlay"
      (click)="closeDeleteStageModal()"
      (keydown.escape)="closeDeleteStageModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content delete-modal">
      <div class="modal-header">
        <h2>Delete Stage</h2>
        <button class="close-button" (click)="closeDeleteStageModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="delete-confirmation">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          <p>
            Are you sure you want to delete the stage "<strong>{{
              selectedStage?.name
            }}</strong
            >"?
          </p>
          <p class="delete-warning">This action cannot be undone.</p>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="cancel-button"
            (click)="closeDeleteStageModal()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
          <button
            type="button"
            class="delete-confirm-button"
            [disabled]="formSubmitting"
            (click)="deleteStage()"
          >
            <i
              class="fas"
              [ngClass]="{
                'fa-spinner fa-spin': formSubmitting,
                'fa-trash-alt': !formSubmitting,
              }"
            ></i>
            <span *ngIf="formSubmitting">Deleting...</span>
            <span *ngIf="!formSubmitting">Delete Stage</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Task Modal -->
  <div class="modal" *ngIf="showCreateTaskModal">
    <div
      class="modal-overlay"
      (click)="closeCreateTaskModal()"
      (keydown.escape)="closeCreateTaskModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Task</h2>
        <button class="close-button" (click)="closeCreateTaskModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="createTaskForm" (ngSubmit)="submitCreateTaskForm()">
          <div class="form-group">
            <label for="title"
              >Task Title <span class="required">*</span></label
            >
            <input
              type="text"
              id="title"
              formControlName="title"
              [class.invalid]="isInvalidControl(createTaskForm, 'title')"
              placeholder="Enter task title"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(createTaskForm, 'title')"
            >
              {{ getControlErrorMessage(createTaskForm, 'title') }}
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              formControlName="description"
              rows="3"
              placeholder="Enter task description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="stageId">Stage <span class="required">*</span></label>
            <select
              id="stageId"
              formControlName="stageId"
              [class.invalid]="isInvalidControl(createTaskForm, 'stageId')"
            >
              <option *ngFor="let column of columns" [value]="column.id">
                {{ column.name }}
              </option>
            </select>
            <div
              class="error-message"
              *ngIf="isInvalidControl(createTaskForm, 'stageId')"
            >
              {{ getControlErrorMessage(createTaskForm, 'stageId') }}
            </div>
          </div>

          <div class="form-group">
            <label for="priority">Priority</label>
            <select id="priority" formControlName="priority">
              <option
                *ngFor="let priority of priorityOptions"
                [value]="priority"
              >
                {{ formatPriority(priority) }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="assignedTo">Assigned To</label>
            <select id="assignedTo" formControlName="assignedTo">
              <option value="">Unassigned</option>
              <option
                *ngFor="let employee of projectEmployees"
                [value]="employee.id"
              >
                {{ employee.fullName }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="type">Type</label>
            <select id="type" formControlName="type">
              <option value="Task">Task</option>
              <option value="Bug">Bug</option>
              <option value="Feature">Feature</option>
              <option value="Draft">Draft</option>
            </select>
          </div>

          <div class="form-group">
            <label for="estimate">Estimate (hours)</label>
            <input
              type="number"
              id="estimate"
              formControlName="estimate"
              min="0"
              step="0.5"
            />
          </div>

          <div class="form-group">
            <label for="images">Task Images</label>
            <div
              class="file-upload"
              (click)="fileInput.click()"
              (keydown.enter)="fileInput.click()"
              tabindex="0"
              role="button"
              aria-label="Upload images"
            >
              <input
                #fileInput
                type="file"
                id="images"
                accept="image/*"
                multiple
                (change)="onTaskImagesSelected($event)"
                style="display: none"
              />
              <i class="fas fa-cloud-upload-alt"></i>
              <p class="upload-text">Click to upload images</p>
            </div>

            <div class="image-previews" *ngIf="taskImagePreviews.length > 0">
              <div
                class="image-preview"
                *ngFor="let preview of taskImagePreviews; let i = index"
              >
                <img [src]="preview" alt="Task image preview" />
                <button
                  class="remove-image"
                  (click)="removeTaskImage(i)"
                  (keydown.enter)="removeTaskImage(i)"
                  tabindex="0"
                  aria-label="Remove image"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="form-error" *ngIf="formError">
            <i class="fas fa-exclamation-triangle"></i>
            {{ formError }}
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="cancel-button"
              (click)="closeCreateTaskModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="formSubmitting || createTaskForm.invalid"
            >
              <i class="fas fa-save"></i>
              <span *ngIf="formSubmitting">Creating...</span>
              <span *ngIf="!formSubmitting">Create Task</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal" *ngIf="showEditTaskModal">
    <div
      class="modal-overlay"
      (click)="closeEditTaskModal()"
      (keydown.escape)="closeEditTaskModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Task</h2>
        <button class="close-button" (click)="closeEditTaskModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editTaskForm" (ngSubmit)="submitEditTaskForm()">
          <div class="form-group">
            <label for="edit-title"
              >Task Title <span class="required">*</span></label
            >
            <input
              type="text"
              id="edit-title"
              formControlName="title"
              [class.invalid]="isInvalidControl(editTaskForm, 'title')"
              placeholder="Enter task title"
            />
            <div
              class="error-message"
              *ngIf="isInvalidControl(editTaskForm, 'title')"
            >
              {{ getControlErrorMessage(editTaskForm, 'title') }}
            </div>
          </div>

          <div class="form-group">
            <label for="edit-description">Description</label>
            <textarea
              id="edit-description"
              formControlName="description"
              rows="3"
              placeholder="Enter task description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="edit-stageId"
              >Stage <span class="required">*</span></label
            >
            <select
              id="edit-stageId"
              formControlName="stageId"
              [class.invalid]="isInvalidControl(editTaskForm, 'stageId')"
            >
              <option *ngFor="let column of columns" [value]="column.id">
                {{ column.name }}
              </option>
            </select>
            <div
              class="error-message"
              *ngIf="isInvalidControl(editTaskForm, 'stageId')"
            >
              {{ getControlErrorMessage(editTaskForm, 'stageId') }}
            </div>
          </div>

          <div class="form-group">
            <label for="edit-priority">Priority</label>
            <select id="edit-priority" formControlName="priority">
              <option
                *ngFor="let priority of priorityOptions"
                [value]="priority"
              >
                {{ formatPriority(priority) }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-assignedTo">Assigned To</label>
            <select id="edit-assignedTo" formControlName="assignedTo">
              <option value="">Unassigned</option>
              <option
                *ngFor="let employee of projectEmployees"
                [value]="employee.id"
              >
                {{ employee.fullName }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-type">Type</label>
            <select id="edit-type" formControlName="type">
              <option value="Task">Task</option>
              <option value="Bug">Bug</option>
              <option value="Feature">Feature</option>
              <option value="Draft">Draft</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-estimate">Estimate (hours)</label>
            <input
              type="number"
              id="edit-estimate"
              formControlName="estimate"
              min="0"
              step="0.5"
            />
          </div>

          <div class="form-group">
            <label for="edit-images">Task Images</label>
            <div
              class="file-upload"
              (click)="editFileInput.click()"
              (keydown.enter)="editFileInput.click()"
              tabindex="0"
              role="button"
              aria-label="Upload images"
            >
              <input
                #editFileInput
                type="file"
                id="edit-images"
                accept="image/*"
                multiple
                (change)="onTaskImagesSelected($event)"
                style="display: none"
              />
              <i class="fas fa-cloud-upload-alt"></i>
              <p class="upload-text">Click to upload new images</p>
            </div>

            <div class="image-previews" *ngIf="taskImagePreviews.length > 0">
              <div
                class="image-preview"
                *ngFor="let preview of taskImagePreviews; let i = index"
              >
                <img [src]="preview" alt="Task image preview" />
                <button
                  class="remove-image"
                  (click)="removeTaskImage(i)"
                  (keydown.enter)="removeTaskImage(i)"
                  tabindex="0"
                  aria-label="Remove image"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <div
              class="image-previews"
              *ngIf="editTaskImagePreviews.length > 0"
            >
              <div
                class="image-preview"
                *ngFor="let url of editTaskImagePreviews"
              >
                <img [src]="url" alt="Existing task image" />
              </div>
            </div>
          </div>

          <div class="form-error" *ngIf="formError">
            <i class="fas fa-exclamation-triangle"></i>
            {{ formError }}
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="cancel-button"
              (click)="closeEditTaskModal()"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="formSubmitting || editTaskForm.invalid"
            >
              <i class="fas fa-save"></i>
              <span *ngIf="formSubmitting">Updating...</span>
              <span *ngIf="!formSubmitting">Update Task</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Task Modal -->
  <div class="modal" *ngIf="showDeleteTaskModal">
    <div
      class="modal-overlay"
      (click)="closeDeleteTaskModal()"
      (keydown.escape)="closeDeleteTaskModal()"
      tabindex="0"
      role="button"
      aria-label="Close modal"
    ></div>
    <div class="modal-content delete-modal">
      <div class="modal-header">
        <h2>Delete Task</h2>
        <button class="close-button" (click)="closeDeleteTaskModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="delete-confirmation">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          <p>
            Are you sure you want to delete the task "<strong>{{
              selectedTask?.title
            }}</strong
            >"?
          </p>
          <p class="delete-warning">This action cannot be undone.</p>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="cancel-button"
            (click)="closeDeleteTaskModal()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
          <button
            type="button"
            class="delete-confirm-button"
            [disabled]="formSubmitting"
            (click)="deleteTask()"
          >
            <i
              class="fas"
              [ngClass]="{
                'fa-spinner fa-spin': formSubmitting,
                'fa-trash-alt': !formSubmitting,
              }"
            ></i>
            <span *ngIf="formSubmitting">Deleting...</span>
            <span *ngIf="!formSubmitting">Delete Task</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Document Modal -->
<div class="modal" *ngIf="showDeleteDocumentModal">
  <div
    class="modal-overlay"
    (click)="closeDeleteDocumentModal()"
    (keydown.escape)="closeDeleteDocumentModal()"
    tabindex="0"
    role="button"
    aria-label="Close modal"
  ></div>
  <div class="modal-content delete-modal">
    <div class="modal-header">
      <h2>Delete Document</h2>
      <button class="close-button" (click)="closeDeleteDocumentModal()">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <div class="delete-confirmation">
        <i class="fas fa-exclamation-triangle warning-icon"></i>
        <p>
          Are you sure you want to delete the document "<strong>{{
            selectedDocument ? getDocumentName(selectedDocument) : ''
          }}</strong
          >"?
        </p>
        <p class="delete-warning">
          This action cannot be undone and will permanently delete the document
          from storage.
        </p>
      </div>

      <div class="form-actions">
        <button
          type="button"
          class="cancel-button"
          (click)="closeDeleteDocumentModal()"
        >
          <i class="fas fa-times"></i> Cancel
        </button>
        <button
          type="button"
          class="delete-confirm-button"
          [disabled]="formSubmitting"
          (click)="deleteDocument()"
        >
          <i
            class="fas"
            [ngClass]="{
              'fa-spinner fa-spin': formSubmitting,
              'fa-trash-alt': !formSubmitting,
            }"
          ></i>
          <span *ngIf="formSubmitting">Deleting...</span>
          <span *ngIf="!formSubmitting">Delete Document</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- New modal for editing project image -->
<div class="modal" *ngIf="showEditProjectImageModal">
  <div
    class="modal-overlay"
    (click)="closeEditProjectImageModal()"
    (keydown.escape)="closeEditProjectImageModal()"
    tabindex="0"
    role="button"
    aria-label="Close modal"
  ></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Project Image</h2>
      <button class="close-button" (click)="closeEditProjectImageModal()">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="editProjectImageForm">
        <div class="form-group">
          <label for="projectImage">
            Project Image <span class="required">*</span>
          </label>
          <div
            class="file-upload"
            (click)="projectImageInput.click()"
            (keydown.enter)="projectImageInput.click()"
            tabindex="0"
            role="button"
            aria-label="Upload project image"
          >
            <input
              #projectImageInput
              type="file"
              id="projectImage"
              accept="image/*"
              (change)="onProjectImageSelected($event)"
              style="display: none"
            />
            <i class="fas fa-cloud-upload-alt"></i>
            <p class="upload-text">
              {{
                selectedProjectImage
                  ? selectedProjectImage.name
                  : 'Click to upload project image'
              }}
            </p>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="cancel-button"
            (click)="closeEditProjectImageModal()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
          <button
            type="button"
            class="submit-button"
            [disabled]="!selectedProjectImage"
            (click)="submitEditProjectImage()"
          >
            <i class="fas fa-save"></i>
            <span *ngIf="formSubmitting">Uploading...</span>
            <span *ngIf="!formSubmitting">Update Image</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Task Modal -->
<div class="modal" *ngIf="showViewTaskModal">
  <div
    class="modal-overlay"
    (click)="closeViewTaskModal()"
    (keydown.escape)="closeViewTaskModal()"
    tabindex="0"
    role="button"
    aria-label="Close modal"
  ></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>Task Details</h2>
      <button class="close-button" (click)="closeViewTaskModal()">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <div class="view-task-content">
        <div class="task-detail-group">
          <h3 class="task-detail-label">Title</h3>
          <p class="task-detail-value">{{ selectedTask?.title }}</p>
        </div>

        <div class="task-detail-group" *ngIf="selectedTask?.description">
          <h3 class="task-detail-label">Description</h3>
          <p class="task-detail-value description">
            {{ selectedTask?.description }}
          </p>
        </div>

        <div class="task-detail-group">
          <h3 class="task-detail-label">Stage</h3>
          <p class="task-detail-value">
            {{ getStageNameById(selectedTask?.stageId) }}
          </p>
        </div>

        <div class="task-detail-group">
          <h3 class="task-detail-label">Priority</h3>
          <p class="task-detail-value">
            <span
              class="task-priority"
              [ngClass]="
                selectedTask && selectedTask.priority
                  ? getPriorityClass(selectedTask.priority)
                  : ''
              "
            >
              {{
                selectedTask && selectedTask.priority
                  ? formatPriority(selectedTask.priority)
                  : 'None'
              }}
            </span>
          </p>
        </div>

        <div class="task-detail-group">
          <h3 class="task-detail-label">Assigned To</h3>
          <p class="task-detail-value">
            {{ getAssignedUserName(selectedTask?.assignedTo) }}
          </p>
        </div>

        <div class="task-detail-group">
          <h3 class="task-detail-label">Type</h3>
          <p class="task-detail-value">{{ selectedTask?.type || 'Task' }}</p>
        </div>

        <div class="task-detail-group">
          <h3 class="task-detail-label">Estimate (hours)</h3>
          <p class="task-detail-value">{{ selectedTask?.estimate || 0 }}</p>
        </div>

        <div class="task-detail-group" *ngIf="viewTaskImagePreviews.length > 0">
          <h3 class="task-detail-label">Images</h3>
          <div class="task-images-gallery">
            <div
              class="image-preview"
              *ngFor="let url of viewTaskImagePreviews"
            >
              <img [src]="url" alt="Task image" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button
          type="button"
          class="cancel-button"
          (click)="closeViewTaskModal()"
        >
          <i class="fas fa-times"></i> Close
        </button>
        <button
          *ngIf="canManageStagesAndTasks()"
          type="button"
          class="submit-button"
          (click)="switchToEditTask()"
        >
          <i class="fas fa-edit"></i> Edit Task
        </button>
      </div>
    </div>
  </div>
</div>
