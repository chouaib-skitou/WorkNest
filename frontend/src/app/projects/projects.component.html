<!-- projects.component.html -->
<div class="projects-container">
  <div class="header-section">
    <div class="header-content">
      <h1>Projects</h1>
      <p class="subtitle">Manage and track your team's projects</p>
    </div>
    <button class="create-button" (click)="openCreateModal()">
      <i class="fas fa-plus"></i> Create Project
    </button>
  </div>

  <div class="filters-section">
    <div class="search-box">
      <i class="fas fa-search search-icon"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="Search projects..."
        class="search-input"
      />
    </div>

    <div class="filter-controls">
      <select
        [(ngModel)]="statusFilter"
        (change)="applyFilters()"
        class="filter-select"
      >
        <option value="All">All Statuses</option>
        <option *ngFor="let status of statusOptions" [value]="status">
          {{ formatStatus(status) }}
        </option>
      </select>

      <select
        [(ngModel)]="priorityFilter"
        (change)="applyFilters()"
        class="filter-select"
      >
        <option value="All">All Priorities</option>
        <option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ formatPriority(priority) }}
        </option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading projects...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <i class="fas fa-exclamation-circle"></i>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="fetchProjects()">Try Again</button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredProjects.length === 0" class="empty-state">
    <i class="fas fa-folder-open"></i>
    <h3>No Projects Found</h3>
    <p>{{ searchTerm ? 'No projects match your search criteria.' : 'Get started by creating your first project.' }}</p>
    <button *ngIf="!searchTerm" class="create-button" (click)="openCreateModal()">
      <i class="fas fa-plus"></i> Create Project
    </button>
  </div>

  <!-- Projects Grid -->
  <div class="projects-grid" *ngIf="!loading && filteredProjects.length > 0">
    <div
      *ngFor="let project of filteredProjects"
      class="project-card"
      [class.has-image]="project.image"
    >
      <div class="project-image" *ngIf="project.image">
        <img [src]="project.image" [alt]="project.name">
      </div>
      <div class="project-card-content" [routerLink]="['/projects', project.id]">
        <div class="project-header">
          <h2>{{ project.name }}</h2>
          <div class="project-badges">
            <span
              class="status-badge"
              [ngClass]="getStatusClass(project.status)"
            >{{ formatStatus(project.status) }}</span>
            <span 
              class="priority-badge" 
              [ngClass]="getPriorityClass(project.priority)"
            >{{ formatPriority(project.priority) }}</span>
          </div>
        </div>
        
        <p class="project-description">{{ project.description || 'No description provided' }}</p>
        
        <div class="project-meta">
          <div class="meta-item due-date">
            <i class="far fa-calendar"></i>
            <span>Due {{ project.dueDate | date: 'MMM d, y' }}</span>
          </div>
          <div class="meta-item assignee">
            <i class="far fa-user"></i>
            <span>{{ getAssigneeName(project) }}</span>
          </div>
        </div>

        <div class="project-footer">
          <div class="team-members" *ngIf="project.employees?.length">
            <div class="member-avatars">
              <div 
                class="member-avatar" 
                *ngFor="let employee of project.employees.slice(0, 3)"
                [title]="employee.fullName"
              >
                {{ employee.fullName.charAt(0) }}
              </div>
              <div 
                class="member-count" 
                *ngIf="project.employees.length > 3"
                [title]="getRemainigMembersNames(project)"
              >
                +{{ project.employees.length - 3 }}
              </div>
            </div>
          </div>
          
          <button 
            class="edit-button" 
            (click)="openUpdateModal(project); $event.stopPropagation()"
            title="Edit Project"
          >
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button
      class="pagination-button"
      [disabled]="currentPage === 1"
      (click)="changePage(currentPage - 1)"
    >
      <i class="fas fa-chevron-left"></i>
      Previous
    </button>

    <div class="page-numbers">
      <ng-container *ngFor="let page of getPages()">
        <button
          *ngIf="page !== '...'"
          class="page-number"
          [class.active]="page === currentPage"
          (click)="changePage(page)"
        >
          {{ page }}
        </button>
        <span *ngIf="page === '...'" class="ellipsis">...</span>
      </ng-container>
    </div>

    <button
      class="pagination-button"
      [disabled]="currentPage === totalPages"
      (click)="changePage(currentPage + 1)"
    >
      Next
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>

  <!-- Create/Update Modal Component -->
  <ng-container *ngTemplateOutlet="projectModal; context: { 
    $implicit: showCreateModal ? 'create' : 'update',
    form: showCreateModal ? createProjectForm : updateProjectForm,
    title: showCreateModal ? 'Create New Project' : 'Update Project',
    submitText: showCreateModal ? 'Create Project' : 'Update Project',
    loadingText: showCreateModal ? 'Creating...' : 'Updating...',
    onClose: showCreateModal ? closeCreateModal : closeUpdateModal,
    onSubmit: showCreateModal ? submitCreateForm : submitUpdateForm
  }"></ng-container>

  <!-- Project Modal Template -->
  <ng-template #projectModal let-mode="$implicit" let-form="form" let-title="title" 
               let-submitText="submitText" let-loadingText="loadingText" 
               let-onClose="onClose" let-onSubmit="onSubmit">
    <div class="modal" *ngIf="showCreateModal || showUpdateModal">
      <div class="modal-overlay" (click)="onClose()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>{{ title }}</h2>
          <button class="close-button" (click)="onClose()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <div class="form-grid">
              <!-- Left Column -->
              <div class="form-column">
                <!-- Project Name -->
                <div class="form-group">
                  <label for="name">Project Name <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="name" 
                    formControlName="name" 
                    [class.invalid]="isInvalidControl(form, 'name')"
                    placeholder="Enter project name"
                  >
                  <div class="error-message" *ngIf="isInvalidControl(form, 'name')">
                    {{ getControlErrorMessage(form, 'name') }}
                  </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                  <label for="description">Description</label>
                  <textarea 
                    id="description" 
                    formControlName="description" 
                    rows="3"
                    placeholder="Describe your project"
                  ></textarea>
                </div>

                <!-- Due Date -->
                <div class="form-group">
                  <label for="dueDate">Due Date <span class="required">*</span></label>
                  <input 
                    type="date" 
                    id="dueDate" 
                    formControlName="dueDate"
                    [class.invalid]="isInvalidControl(form, 'dueDate')"
                    [min]="today"
                  >
                  <div class="error-message" *ngIf="isInvalidControl(form, 'dueDate')">
                    {{ getControlErrorMessage(form, 'dueDate') }}
                  </div>
                </div>
              </div>

              <!-- Right Column -->
              <div class="form-column">
                <!-- Status -->
                <div class="form-group">
                  <label for="status">Status <span class="required">*</span></label>
                  <select 
                    id="status" 
                    formControlName="status"
                    [class.invalid]="isInvalidControl(form, 'status')"
                  >
                    <option *ngFor="let status of statusOptions" [value]="status">
                      {{ formatStatus(status) }}
                    </option>
                  </select>
                  <div class="error-message" *ngIf="isInvalidControl(form, 'status')">
                    {{ getControlErrorMessage(form, 'status') }}
                  </div>
                </div>

                <!-- Priority -->
                <div class="form-group">
                  <label for="priority">Priority <span class="required">*</span></label>
                  <select 
                    id="priority" 
                    formControlName="priority"
                    [class.invalid]="isInvalidControl(form, 'priority')"
                  >
                    <option *ngFor="let priority of priorityOptions" [value]="priority">
                      {{ formatPriority(priority) }}
                    </option>
                  </select>
                  <div class="error-message" *ngIf="isInvalidControl(form, 'priority')">
                    {{ getControlErrorMessage(form, 'priority') }}
                  </div>
                </div>

                <!-- Manager -->
                <div class="form-group">
                  <label for="managerId">Manager</label>
                  <select id="managerId" formControlName="managerId">
                    <option value="">Select a manager</option>
                    <option *ngFor="let manager of managers" [value]="manager.id">
                      {{ manager.fullName }}
                    </option>
                  </select>
                </div>

                <!-- Employees -->
                <div class="form-group">
                  <label for="employeeIds">Team Members</label>
                  <div class="select-wrapper">
                    <select id="employeeIds" formControlName="employeeIds" multiple>
                      <option *ngFor="let employee of employees" [value]="employee.id">
                        {{ employee.fullName }}
                      </option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple team members</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- File Uploads -->
            <div class="form-section">
              <h3>Attachments</h3>
              
              <!-- Image Upload -->
              <div class="form-group upload-group">
                <label for="image">Project Image</label>
                <div class="upload-area" 
                     [class.has-preview]="imagePreview"
                     (click)="triggerImageUpload()">
                  <input 
                    #imageInput
                    type="file" 
                    id="image" 
                    accept="image/*"
                    (change)="onImageSelected($event)"
                    hidden
                  >
                  <div class="upload-placeholder" *ngIf="!imagePreview">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload project image</p>
                    <span>or drag and drop</span>
                  </div>
                  <div class="image-preview" *ngIf="imagePreview">
                    <img [src]="imagePreview" alt="Project image preview">
                    <button type="button" class="remove-image" (click)="removeImage($event)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Documents Upload -->
              <div class="form-group upload-group">
                <label for="documents">Project Documents</label>
                <div class="upload-area" 
                     [class.has-files]="selectedDocuments.length > 0"
                     (click)="triggerDocumentUpload()">
                  <input 
                    #documentsInput
                    type="file" 
                    id="documents" 
                    multiple
                    (change)="onDocumentsSelected($event)"
                    hidden
                  >
                  <div class="upload-placeholder" *ngIf="selectedDocuments.length === 0">
                    <i class="fas fa-file-upload"></i>
                    <p>Click to upload documents</p>
                    <span>or drag and drop</span>
                  </div>
                  <div class="documents-list" *ngIf="selectedDocuments.length > 0">
                    <div class="document-item" *ngFor="let doc of selectedDocuments; let i = index">
                      <i class="fas fa-file"></i>
                      <span class="document-name">{{ doc.name }}</span>
                      <button type="button" class="remove-document" (click)="removeDocument(i, $event)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Error -->
            <div class="form-error" *ngIf="formError">
              <i class="fas fa-exclamation-circle"></i>
              {{ formError }}
            </div>

            <!-- Submit Buttons -->
            <div class="form-actions">
              <button type="button" class="cancel-button" (click)="onClose()">
                <i class="fas fa-times"></i>
                Cancel
              </button>
              <button 
                type="submit" 
                class="submit-button" 
                [disabled]="formSubmitting || form.invalid"
              >
                <i class="fas" [class.fa-spinner]="formSubmitting" [class.fa-save]="!formSubmitting"></i>
                <span *ngIf="formSubmitting">{{ loadingText }}</span>
                <span *ngIf="!formSubmitting">{{ submitText }}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </ng-template>
</div>